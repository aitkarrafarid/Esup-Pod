#----------------------------------------------------------------------------
#      .---_
#      / / /\|
#     / / | \ *
#    /  /  \ \           Liste des images de conteneurs
#   / /  / \  \          pour l'application esup-pod
# ./~~~~~~~~~~~\.
#( .",^. -". '.~ )
# '~~~~~~~~~~~~~'
#----------------------------------------------------------------------------
# Images officielles (un registry d'entreprise est recommandé)
busybox_image: &my_busybox_image "harbor.urba.univ-lille.fr/store/busybox:1.28"
db_image: &my_db_image "harbor.urba.univ-lille.fr/store/mariadb:10.7.8"
redis_image: &my_redis_image "harbor.urba.univ-lille.fr/store/redis:7-alpine"
nginx_image: &my_nginx_image "harbor.urba.univ-lille.fr/store/nginx:1.24.0"
rediscommander_image: &my_rediscommander_image "harbor.urba.univ-lille.fr/store/rediscommander/redis-commander:latest"
phpmyadmin_image: &my_phpmyadmin_image "harbor.urba.univ-lille.fr/store/phpmyadmin:5.2.1"
flower_image: &my_flower_image "harbor.urba.univ-lille.fr/store/mher/flower:1.2"
# Images locales à recupérer depuis un registry d'entreprise
# Indiquez votre registry interne en remplacement de harbor.urba.univ-lille.fr
uwsgi_image: &my_uwsgi_image "harbor.urba.univ-lille.fr/univ-lorraine/uwsgi_pod:3.1.1"
#uwsgi_image: &my_uwsgi_image "harbor.esup-portail.org/store-custom/univ-lille/esup-pod/uwsgi_pod:3.1.1"
#uwsgi_image: &my_uwsgi_image "harbor.esup-portail.org/store-custom/univ-lille/esup-pod/uwsgi_pod:3.2.0"
elastic_image: &my_elastic_image "harbor.urba.univ-lille.fr/univ-lorraine/elastic_pod:7.17.7"
#elastic_image: &my_elastic_image "harbor.esup-portail.org/store-custom/univ-lille/esup-pod/elastic_pod:7.17.7"
#----------------------------------------------------------------------------
#  (\___/) (\_(\
#  (='.'=) (=':')                 global
#  (")_(") (,(")(")
#----------------------------------------------------------------------------
global:
  metadata:
    label:
      app: esup-pod
  # TODO en l'etat, le namespace est obligatoire dans le PersistentVolume
  namespace: esup-pod
  #----------------------------------------------------------------------------
  # * @storageClassName :
  #  NAME                   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
  #  local-path (default)   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  8m8s
  #   - local-path (créé des volumes persistants non visible)
  #   - standard (créé des volumes persistants visible)
  #   - Autres classes de stockage locale à implémenter avant l'execution de ce chart HELM...
  #
  #----------------------------------------------------------------------------
  persistent_volume_enabled: true
  storageClassName: local-path
#  storageClassName: standard
  volumeMounts:
    django_settings:
      mountPath: /app/pod/custom/settings_local.py
    data_pv:
      mountPath: /pod
  secret:
    ESUP_POD_DB_USER: pod # cG9k
    ESUP_POD_DB_PASS: cGFzc3dvcmQ= # password
    MARIADB_ROOT_PASSWORD: cGFzc3dvcmQ= # password
  #----------------------------------------------------------------------------
  # * @type :
  #   - ingress (ngnix / traefik)
  #   - gateway_virtualservice (istio)
  #----------------------------------------------------------------------------
  IngressController:
    type: "ingress"
  #----------------------------------------------------------------------------
  # * @Services facultatifs :
  #   - redis-commander
  #   - phpmyadmin
  #   - flower
  #----------------------------------------------------------------------------
  # TODO autoscaling en cours... Laissez à false
  autoscaling:
    enabled: false
  redis_commander:
    enabled: false
  phpmyadmin:
    enabled: false
  flower:
    enabled: false

#----------------------------------------------------------------------------
#   0"""0
#  ( �.�,)                          db
#  (")_(")
#----------------------------------------------------------------------------
db:
  module: db
  PersistentVolume:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
    persistentVolumeReclaimPolicy: Retain
    hostPath:
      path: "/tmp/esup/pod/db"
  PersistentVolumeClaim:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
  Service:
    type: ClusterIP
    port: 3306
  Deployment:
    replicas: 1
    containers:
      image: *my_db_image
      volumeMounts:
        mountPath: /var/lib/mysql
  ConfigMap:
     ESUP_POD_DB_NAME: pod
#----------------------------------------------------------------------------
#  (-_-)
#  -[]-                       elasticsearch
#   /\
#----------------------------------------------------------------------------
elasticsearch:
  module: elastic
  PersistentVolume:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
    persistentVolumeReclaimPolicy: Retain
    hostPath:
      path: "/tmp/esup/pod/elastic"
  PersistentVolumeClaim:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
  Service:
    type: ClusterIP
    port: 9200
  Deployment:
    replicas: 1
    containers:
      image: *my_elastic_image
      volumeMounts:
        mountPath: /usr/share/elasticsearch/data
      initContainers:
        image: *my_busybox_image
  ConfigMap:
    ESUP_POD_CLUSTER_NAME: esup-pod-k8s-cluster
    ESUP_POD_NETWORK_HOST: "0.0.0.0"
    ESUP_POD_INGEST_GEOIP_DOWNLOADER_ENABLED: "false"
    ESUP_POD_SECURITY_ENABLED: "false"
    ESUP_POD_ML_ENABLED: "false"
    ESUP_POD_MONITORING_ENABLED: "false"
    ESUP_POD_GRAPH_ENABLED: "false"
    ESUP_POD_WATCHER_ENABLED: "false"
    ESUP_POD_MEMORY_LOCK: "true"
    ESUP_POD_DISCOVERY_TYPE: "single-node"
#----------------------------------------------------------------------------
#       .---_
#       / / /\|
#      / / | \ *
#     /  /  \ \                      redis
#    / /  / \  \
#  ./~~~~~~~~~~~\.
# ( .",^. -". '.~ )
#----------------------------------------------------------------------------
redis:
  module: redis
  PersistentVolume:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
    persistentVolumeReclaimPolicy: Retain
    hostPath:
      path: "/tmp/esup/pod/redis"
  PersistentVolumeClaim:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
  Service:
    type: ClusterIP
    port: 6379
  Deployment:
    replicas: 1
    containers:
      image: *my_redis_image
      volumeMounts:
        redis_conf:
          mountPath: /usr/local/etc/redis/redis.conf
        redis_pv:
          mountPath: /data
#----------------------------------------------------------------------------
#                              (_)(_)
#                             /     \
#                            /       |
#                           /   \  * |
#             ________     /    /\__/                  backend
#     _      /        \   /    /
#    / \    /  ____    \_/    /
#   //\ \  /  /    \         /
#   V  \ \/  /      \       /
#       \___/        \_____/
#----------------------------------------------------------------------------
backend:
  module: uwsgi
  ESUP_POD_DB_ENGINE: django.db.backends.mysql
  PersistentVolume:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
    persistentVolumeReclaimPolicy: Retain
    hostPath:
      path: "/tmp/esup/pod/esup-pod-data"
  PersistentVolumeClaim:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
  Service:
    type: ClusterIP
    port: 80
  Deployment:
    replicas: 1
    containers:
      image: *my_uwsgi_image
      volumeMounts:
        uwsgi_conf:
          mountPath: /etc/esup-pod-uwsgi-conf.ini
      initContainers:
        image: *my_busybox_image
  settings:
    DJANGO_SUPERUSER_USERNAME: admin # YWRtaW4=
    DJANGO_SUPERUSER_PASSWORD: password # cGFzc3dvcmQ=
    # DJANGO_SUPERUSER_EMAIL: admin-pod@univ.fr # YWRtaW4tcG9kQHVuaXYuZnI=
    DJANGO_SUPERUSER_EMAIL: farid.aitkarra@univ-lille.fr # ZmFyaWQuYWl0a2FycmFAdW5pdi1saWxsZS5mcg==
    # ESUP_POD_EMAIL_USER: admin-pod # YWRtaW4tcG9k
    ESUP_POD_EMAIL_USER: farid.aitkarra # ZmFyaWQuYWl0a2FycmE=
    # ESUP_POD_EMAIL_PASS: password # cGFzc3dvcmQ=
    # TODO, perso à supprimer !!!
    ESUP_POD_EMAIL_PASS: VWxpbGxlJG8kbzEzMDIyMDA1 # echo -n 'MyPwd' | base64
    ##
    # The secret key for your particular Django installation.
    #
    # This is used to provide cryptographic signing,
    # and should be set to a unique, unpredictable value.
    #
    # Django will not start if this is not set.
    # https://docs.djangoproject.com/fr/3.2/ref/settings/#secret-key
    #
    # SECURITY WARNING: keep the secret key used in production secret!
    # You can visit https://djecrety.ir/ to get it
    ESUP_POD_SECRET_KEY: nvw#m9#-g1c8(n5a(zv60opp44**$!m1kc5%vrqx1fb5k25a(z
    ESUP_POD_PUBLIC_BASE_URL: "http://localhost:8080"
    ESUP_POD_DB_NAME: pod
    ESUP_POD_EMAIL_HOST: smtp.univ-lille.fr
    ESUP_POD_EMAIL_PORT: "587"
#    ESUP_POD_EMAIL_USE_TLS: "True"
    ESUP_POD_EMAIL_USE_TLS: "False"
    ESUP_POD_EMAIL_FROM: farid.aitkarra@univ-lille.fr
#    ESUP_POD_USE_CAS: "True"
    ESUP_POD_USE_CAS: "False"
    ESUP_POD_CAS_SERVER_URL: "https://auth.univ.fr/"
    ESUP_POD_CAS_GATEWAY: "False"
    ESUP_POD_USER_CAS_MAPPING_ATTRIBUTES: "{'uid': 'uid', 'mail': 'mail', 'last_name': 'sn', 'first_name': 'givenname', 'primaryAffiliation': 'edupersonprimaryaffiliation', 'affiliation': 'edupersonprimaryaffiliation', 'affiliations': 'edupersonaffiliation'}"
    ESUP_POD_AFFILIATION_STAFF: "('staff')"
#    ESUP_POD_AFFILIATION: "(('staff', 'employee','faculty'), ('faculty', 'factulty'), ('staff','Personnel'), ('employee','Employé'), ('member','Membre de l\\\'établissement'), ('affiliate','Partenaire extérieur'), ('alum','Ancien étudiant'), ('researcher','Chercheur'), ('retired','Retraité'), ('emeritus','Professeur émerite'), ('teacher','Ensignant'), ('registered-reader','lecteur de bibliothèque autorisé'))"
    ESUP_POD_AFFILIATION: "('faculty', 'factulty'), ('staff','Personnel')"
    ESUP_POD_VIDEO_MAX_UPLOAD_SIZE: "10"
    ESUP_POD_FILE_MAX_UPLOAD_SIZE: "10"
    ESUP_POD_EMAIL_ON_ENCODING_COMPLETION: "True"
    ESUP_POD_EMAIL_ADMIN_ON_ENCODING_COMPLETION: "False"
    ESUP_POD_RESTRICT_EDIT_VIDEO_ACCESS_TO_STAFF_ONLY: "True"
    ESUP_POD_LANGUAGE_CODE: "fr"
    ESUP_POD_TIME_ZONE: "Europe/Paris"
    ESUP_POD_REDIS_QUEUE_CELERY: "4"
    ESUP_POD_REDIS_QUEUE_CACHE: "2"
    ESUP_POD_REDIS_QUEUE_SESSION: "3"
    UWSGI:
      chdir: /app
      processes: 3
      socket: 0.0.0.0:80
#----------------------------------------------------------------------------
#     __   __
#     \/---\/
#      ). .(
#     ( (") )
#      )   (                                    encoder
#     /     \
#    (       )
#   ( \ /-\ / )
#    w'W   W'w
#----------------------------------------------------------------------------
encoder:
  module: encoder
  hpa:
    apiVersion: autoscaling/v2beta2
    # Warning: autoscaling/v2beta2 HorizontalPodAutoscaler is deprecated in v1.23+, unavailable in v1.26+; use autoscaling/v2 HorizontalPodAutoscaler
#    apiVersion: autoscaling/v2
    maxReplicas: 1
    metrics:
      cpu:
        averageUtilization: 50
  Service:
    type: ClusterIP
    port: 8080
  Deployment:
    replicas: 1
    # https://www.padok.fr/blog/pods-evicted-kubernetes
    resources:
      requests:
        cpu: "1"
        memory: "1024Mi"
      limits:
        cpu: "1"
        memory: "1024Mi"
    containers:
      image: *my_uwsgi_image
      initContainers:
        image: *my_busybox_image
  settings:
    CELERY_BROKER_URL: esup-pod-redis.esup-pod.svc.cluster.local:6379 # ZXN1cC1wb2QtcmVkaXMuZXN1cC1wb2Quc3ZjLmNsdXN0ZXIubG9jYWw6NjM3OQ==
#----------------------------------------------------------------------------
#     __
#   <(o )___                              ngnix
#    ( ._> /
#     `---'
#----------------------------------------------------------------------------
ngnix:
  host: "esup-pod.localhost.traefik"
  module: nginx
  Service:
    type: ClusterIP
    port: 8080
  Deployment:
    replicas: 1
    containers:
      image: *my_nginx_image
      volumeMounts:
        nginx_conf_default:
          mountPath: /etc/nginx/conf.d/default.conf
        nginx_conf_htpasswd_users:
          mountPath: /etc/nginx/htpasswd.users
      initContainers:
        image: *my_busybox_image
  settings:
    #https://www.web2generators.com/apache-tools/htpasswd-generator
    htpasswd_users: pod:$apr1$32nqcd9u$NIz6eqY7E3C8kzf4dJdmG1
    upstream_django_server: esup-pod-backend:80
    upstreamrediscommander: http://esup-pod-redis-commander:8081
    upstreamflower: http://esup-pod-flower
    upstreamphpmyadmin: http://esup-pod-phpmyadmin:80
#----------------------------------------------------------------------------
#     __       __
#    / <`     '> \
#   (  / @   @ \  )
#    \(_ _\_/_ _)/
#  (\ `-/     \-' /)                  cron
#   "===\     /==="
#    .==')___(`==.
#   ' .='     `=.
#----------------------------------------------------------------------------
cronjob:
  cron_checkobsoletevideos:
    schedule: "0 8 * * *"
    module: cron-checkobsoletevideos
    containers:
      image: *my_uwsgi_image
  cron_cleanchunk:
    schedule: "0 5 * * *"
    module: cron-cleanchunk
    containers:
      image: *my_uwsgi_image
  cron_clearsessions:
    schedule: "0 1 * * *"
    module: cron-clearsessions
    containers:
      image: *my_uwsgi_image

redis-commander:
  host: "redis-commander.localhost.traefik"
  module: redis-commander
  Service:
    port: 8081
    type: ClusterIP
  Deployment:
    replicas: 1
    containers:
      image: *my_rediscommander_image
      initContainers:
        image: *my_busybox_image

phpmyadmin:
  host: "phpmyadmin.localhost.traefik"
  module: phpmyadmin
  Service:
    port: 80
    type: ClusterIP
  Deployment:
    replicas: 1
    containers:
      image: *my_phpmyadmin_image
      initContainers:
        image: *my_busybox_image

flower:
  host: "flower.localhost.traefik"
  module: flower
  Service:
    port: 80
    type: ClusterIP
  Deployment:
    replicas: 1
    containers:
      image: *my_flower_image
      volumeMounts:
        mountPath: /data
      initContainers:
        image: *my_busybox_image
  PersistentVolume:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi
    persistentVolumeReclaimPolicy: Retain
    hostPath:
      path: "/tmp/esup/pod/flower"
  PersistentVolumeClaim:
    accessModes: ReadWriteOnce
    capacity:
      storage: 1Gi